# Phase 1 详细计划：项目骨架与 MinerU 集成

| **项目** | **内容** |
| --- | --- |
| **阶段目标** | 验证 MinerU API 可用性，完成核心解析流程 |
| **关键产出** | 可运行的 CLI 工具，能解析 PDF 并输出 Markdown |
| **依赖条件** | MinerU API Token |

---

## 1. 总体目标

建立项目的基础框架，并验证核心功能——能够将 PDF 文件发送到 MinerU 云服务进行解析，并获取结果。这是整个工具的"心脏"部分。

---

## 2. 具体任务说明

### 2.1 初始化 Python 项目结构

**通俗解释**：

就像盖房子需要先打地基、规划房间布局一样，我们需要先搭建项目的"骨架"。这包括：
- 创建标准的文件夹结构（哪里放代码、哪里放测试、哪里放文档）
- 配置项目依赖管理（告诉 Python 这个项目需要用到哪些外部工具）
- 设置开发环境（让其他开发者能轻松运行这个项目）

**具体文件/目录**：

```
p2r/
├── pyproject.toml          # 项目配置文件（类似"说明书"）
├── README.md               # 项目介绍
├── src/
│   └── p2r/                # 主代码目录
│       ├── __init__.py
│       ├── cli.py          # 命令行入口
│       ├── config.py       # 配置管理
│       └── mineru.py       # MinerU 客户端
└── tests/                  # 测试代码
```

**验证方式**：

- [ ] 能够运行 `pip install -e .` 在开发模式安装项目
- [ ] 能够执行 `p2r --version` 显示版本号
- [ ] 项目结构符合 Python 标准（可用 `tree` 命令检查）

---

### 2.2 实现配置管理模块

**通俗解释**：

工具需要"记住"用户的设置，比如 API 密钥、文件夹路径等。这个模块就像一个"记事本"，能：
- 第一次使用时创建配置文件
- 读取用户保存的设置
- 更新设置（用户修改配置时）

**配置文件位置**：`~/.p2r_config.json`（用户主目录下的隐藏文件）

**核心功能**：

| 函数名 | 作用 |
| --- | --- |
| `load_config()` | 读取配置文件，返回配置字典 |
| `save_config()` | 将配置写入文件 |
| `get_default_config()` | 返回默认配置模板 |

**验证方式**：

- [ ] 运行时若配置文件不存在，能自动创建默认配置
- [ ] 手动修改配置文件后，程序能正确读取新值
- [ ] 配置文件权限为 `600`（仅用户可读写，保护 API Token）
- [ ] 环境变量 `P2R_MINERU_TOKEN` 优先级高于配置文件

---

### 2.3 实现 MinerU API 客户端

**通俗解释**：

这是 Phase 1 的核心！我们需要编写代码与 MinerU 云服务"对话"，完成以下流程：

```
申请上传链接 → 上传文件 → 轮询状态 → 下载结果
```

#### 2.3.1 申请上传链接

| 项目 | 说明 |
| --- | --- |
| **做什么** | 告诉 MinerU"我要上传一个 PDF"，它会返回一个临时的上传地址 |
| **技术细节** | 调用 `POST /file-urls/batch` API |
| **验证** | 能拿到有效的上传 URL |

#### 2.3.2 上传文件

| 项目 | 说明 |
| --- | --- |
| **做什么** | 把 PDF 文件上传到 MinerU 提供的临时地址 |
| **技术细节** | 使用 `PUT` 方法上传到第 1 步获取的 URL |
| **验证** | 上传成功返回 HTTP 200 |

#### 2.3.3 轮询任务状态

| 项目 | 说明 |
| --- | --- |
| **做什么** | 因为解析需要时间，我们要不断问 MinerU"解析好了吗？"，直到完成 |
| **技术细节** | 定期调用 `GET /extract-results/batch/{id}`，检查状态 |
| **验证** | 能正确识别 `processing`、`completed`、`failed` 状态 |

#### 2.3.4 下载结果

| 项目 | 说明 |
| --- | --- |
| **做什么** | 解析完成后，下载包含 Markdown 和图片的 ZIP 压缩包 |
| **技术细节** | 从 API 响应中获取 `zip_url`，下载并解压到临时目录 |
| **验证** | ZIP 文件完整，能正确解压出 `.md` 和图片文件 |

**代码结构示例**：

```python
class MinerUClient:
    def request_upload_url(self, filename: str) -> str:
        """申请上传链接"""

    def upload_file(self, file_path: str, upload_url: str):
        """上传文件到临时地址"""

    def poll_status(self, batch_id: str) -> dict:
        """轮询任务状态"""

    def download_result(self, zip_url: str, output_dir: str):
        """下载并解压结果"""
```

---

### 2.4 添加基础 CLI 命令

**通俗解释**：

让用户能在终端输入 `p2r convert paper.pdf` 来触发整个流程。这部分只需要：
- 接收文件路径参数
- 调用 MinerU 客户端完成解析
- 将结果下载到临时目录
- 打印基本信息（暂不涉及重命名、移动文件等复杂逻辑）

**最小可用版本**：

```bash
$ p2r convert test.pdf
正在上传文件...
正在解析 (0/15 页)...
正在解析 (5/15 页)...
正在解析 (15/15 页)...
下载完成！结果保存在: /tmp/p2r_xyz/
```

**验证方式**：

- [ ] 能够解析单个 PDF 文件
- [ ] 解析失败时显示友好的错误信息
- [ ] 生成的 Markdown 文件内容正确（标题、段落、图片链接存在）

---

## 3. Phase 1 完整验证清单

### 3.1 功能验证

- [ ] **项目安装**：`pip install -e .` 成功
- [ ] **配置初始化**：首次运行自动创建 `~/.p2r_config.json`
- [ ] **Token 验证**：能够使用真实 MinerU API Token 进行认证
- [ ] **单文件解析**：成功解析一个简单的学术 PDF（如 5 页以内的论文）
- [ ] **大文件解析**：成功解析一个复杂 PDF（20+ 页，包含图表）
- [ ] **错误处理**：
  - 无效 Token 时提示清晰错误
  - 网络断开时能捕获异常
  - 超大文件（>200MB）时拒绝上传并提示

### 3.2 测试用例

准备以下测试 PDF：

| 类型 | 描述 | 预期结果 |
| --- | --- | --- |
| 简单文本 PDF | 纯文本，无图片，5 页 | 完整提取文本内容 |
| 图文混排 PDF | 包含插图、表格 | 图片正确提取到单独文件夹 |
| 双栏论文 | 典型学术论文格式 | 文本顺序正确（不混乱） |
| 扫描 PDF | 图片型 PDF | OCR 识别出文字 |

### 3.3 性能基准

- [ ] 单个 10 页 PDF 解析时间 < 1 分钟（取决于 MinerU 服务速度）
- [ ] 轮询间隔设置合理（建议 2-5 秒）
- [ ] 临时文件正常清理（进程结束后 `/tmp/p2r_*` 目录被删除）

---

## 4. 开发顺序建议

| 阶段 | 任务 | 说明 |
| --- | --- | --- |
| 第 1-2 天 | 项目结构 + 配置管理 | 基础设施搭建 |
| 第 3-5 天 | MinerU API 客户端 | 这是最复杂的部分 |
| 第 6 天 | 基础 CLI 命令 | 整合各模块 |
| 第 7 天 | 集成测试 + 文档 | 验证完整流程 |

---

## 5. 成功标志

Phase 1 完成后，你应该能够：

1. 在终端运行 `p2r convert paper.pdf`
2. 看到实时进度提示
3. 在临时目录得到解析后的 Markdown 文件和图片
4. Markdown 内容可读，图片引用路径正确

**此时工具尚未实现**：

| 功能 | 状态 | 计划阶段 |
| --- | --- | --- |
| 文件重命名 | 未实现 | Phase 2 |
| 移动到 Obsidian 目录 | 未实现 | Phase 2 |
| 图片上传到图床 | 未实现 | Phase 3 |
| 元数据提取 | 未实现 | Phase 2 |
| Frontmatter 生成 | 未实现 | Phase 2 |

Phase 1 的重点是**验证 MinerU 能用**，后续阶段才打磨用户体验。

---

## 6. 相关文档

- [PRD.md](./PRD.md) - 产品需求文档
- [mineru_api_reference.md](./mineru_api_reference.md) - MinerU API 参考
